jQuery.desaturate={defaults:{'onswitch':null,'iefix':true,'ie9canvas':true,'level':1,'rgb':[0.3333,0.3333,0.3333],'colorize':[0,0,0]},customClass:'js-desaturate-fixed'};jQuery.desaturate.Image=function(a){this.image=a;this.canvas=null;this.options={};this.jImage=jQuery(this.image);var b=this;this.jImage.bind("load.desaturate",function(){b.imageLoaded.call(b)});this.loaded=this.image.complete;this.src=this.jImage.attr('src');this.isPNG=this.jImage.is("IMG[src$=.png]");var c=new String(this.jImage.css('width'));c=c.replace(/px/,'');var d=new String(this.jImage.css('height'));d=d.replace(/px/,'');this.width=this.jImage.width()?this.jImage.width():(c?c:this.jImage.attr('width'));this.height=this.jImage.height()?this.jImage.height():(d?d:this.jImage.attr('height'));this.imgFilter='';if(this.image.style.filter){this.imgFilter='filter:'+this.image.style.filter+';';this.image.style.filter=''}this.image.style.width='';this.image.style.height='';this.imgId=this.jImage.attr('id')?'id="'+this.jImage.attr('id')+'" ':'';this.imgClass='class="'+this.jImage.attr('class')+' '+jQuery.desaturate.customClass+'" ';this.imgTitle=this.jImage.attr('title')?'title="'+this.jImage.attr('title')+'" ':'';this.imgAlt=this.jImage.attr('alt')?'alt="'+this.jImage.attr('alt')+'" ':'';this.imgStyles=this.image.style.cssText;this.imgStyles+=this.jImage.attr('align')?'float:'+this.jImage.attr('align')+';':'';this.imgStyles+=this.jImage.parent().attr('href')?'cursor:hand;':'';this.imgStyles=this.imgStyles.replace(/filter:/i,'');this.imgCssSize=(this.width&&this.height)?'width:'+this.width+'px;'+'height:'+this.height+'px;':''};jQuery.desaturate.Image.prototype.imageLoaded=function(){this.loaded=true;this.jImage.unbind("load.desaturate");if(this.canvas){this.replaceImageWithCanvas();this.canvas=null}};jQuery.desaturate.Image.prototype.replace=function(a){return jQuery(a).replaceAll(this.image).get(0)};jQuery.desaturate.Image.prototype.prepareCanvas=function(){var a='<canvas style="display:inline-block;'+this.imgStyles+this.imgCssSize+'" ';a+=this.imgId+this.imgClass+this.imgTitle+this.imgAlt+'></canvas>';this.canvas=jQuery(a).get(0);return this.canvas};jQuery.desaturate.Image.prototype.switchToCanvas=function(){if(this.loaded&&this.canvas){this.replaceImageWithCanvas();this.canvas=null}};jQuery.desaturate.Image.prototype.replaceImageWithCanvas=function(){var a=this.replace(this.getCanvas());if(typeof(this.options.onswitch)=='function')this.options.onswitch.call(a)};jQuery.desaturate.Image.prototype.getCanvas=function(){var a=this.options;var b=this.canvas;var c=b.getContext('2d');var d=this.width;var e=this.height;b.width=d;b.height=e;c.drawImage(this.image,0,0);var f=c.getImageData(0,0,d,e);var g=1-a.level;for(var y=0;y<f.height;y++){for(var x=0;x<f.width;x++){var i=y*4*f.width+x*4;var h=f.data[i]*a.rgb[0]+f.data[i+1]*a.rgb[1]+f.data[i+2]*a.rgb[2];h=h*a.level;var j=255-h;f.data[i]=h+a.colorize[0]-Math.round(h*a.colorize[0]/255)+Math.round(f.data[i]*g);f.data[i+1]=h+a.colorize[1]-Math.round(h*a.colorize[1]/255)+Math.round(f.data[i+1]*g);f.data[i+2]=h+a.colorize[2]-Math.round(h*a.colorize[2]/255)+Math.round(f.data[i+2]*g)}}c.putImageData(f,0,0,0,0,f.width,f.height);return b};jQuery.desaturate.Image.prototype.getIeFix=function(){var a='display:block;background:transparent;padding:0;margin:0;';var b='<span style="display:inline-block;'+this.imgStyles+this.imgCssSize+'" ';b+=this.imgId+this.imgClass+this.imgTitle+this.imgAlt+'>';b+='<span style="'+a+this.imgCssSize+this.imgFilter+'">';if(this.isPNG){b+='<span style="'+a+this.imgCssSize;b+='filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=\''+this.src+'\', sizingMethod=\'crop\');">';b+='</span>'}else{b+='<img style="'+a+this.imgCssSize+'" '+this.imgTitle+this.imgAlt;b+=' src="'+this.src+'">'}b+='</span>';b+='</span>';return jQuery(b).get(0)};jQuery.fn.desaturate=function(g){var h=[];var i=jQuery.extend(true,{},jQuery.desaturate.defaults,g);this.each(function(){var a=this;var b=null;var c=jQuery.extend(true,{},i,jQuery.metadata?jQuery(a).metadata():{},jQuery(a).data('desaturate'));var d=parseInt($.browser.version,10);var e=jQuery.browser.msie&&(d<9||!c.ie9canvas);if(e&&jQuery(a).is("IMG")&&c.iefix){b=new jQuery.desaturate.Image(a);b.options=c;a=b.replace(b.getIeFix())}if(e&&(jQuery(a).is("IMG")||jQuery(a).hasClass(jQuery.desaturate.customClass))){var f=a;if(jQuery(a).hasClass(jQuery.desaturate.customClass)){f=jQuery("SPAN",a).get(0)}f.style.filter=(f.style.filter?f.style.filter+' ':'')+'progid:DXImageTransform.Microsoft.BasicImage(grayScale=1)';if(typeof(c.onswitch)=='function')jQuery.proxy(c.onswitch,a)}if(!e&&(jQuery(a).is("IMG"))){b=new jQuery.desaturate.Image(a);b.options=c;a=b.prepareCanvas();b.switchToCanvas()}h.push(a)});return this.pushStack(h,"desaturate","")};jQuery.fn.desaturateImgFix=function(c){if(!jQuery.browser.msie){return this}var d=jQuery.extend(true,{},jQuery.desaturate.defaults,c);var e=[];this.each(function(){var a=jQuery.extend(true,{},d,jQuery.metadata?jQuery(this).metadata():{},jQuery(this).data('desaturate'));if(!jQuery(this).is("IMG")){e.push(this)}else{var b=new jQuery.desaturate.Image(this);b.options=a;e.push(b.replace(b.getIeFix()))}});return this.pushStack(e,"desaturateImgFix","")};